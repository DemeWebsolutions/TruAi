<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TruAi â€“ Login</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .login-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 40px;
      width: 100%;
      max-width: 480px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .logo {
      text-align: center;
      margin-bottom: 32px;
    }

    .logo h1 {
      font-size: 2rem;
      font-weight: 700;
      color: #667eea;
      letter-spacing: -0.5px;
    }

    .logo p {
      color: #666;
      font-size: 0.875rem;
      margin-top: 4px;
    }

    .status-msg {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 0.875rem;
      display: none;
    }

    .status-msg.info    { background: #e8f4fd; color: #1a6aa8; border: 1px solid #bee3f8; display: block; }
    .status-msg.success { background: #e6fffa; color: #276749; border: 1px solid #9ae6b4; display: block; }
    .status-msg.error   { background: #fff5f5; color: #c53030; border: 1px solid #fed7d7; display: block; }

    .auth-methods {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 24px;
    }

    .auth-card {
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      background: #fff;
    }

    .auth-card:hover:not(.disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .auth-card.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .auth-card.biometric  { border-color: #667eea; background: linear-gradient(135deg, #ebf4ff, #f0e6ff); }
    .auth-card.autofill   { border-color: #9f7aea; background: linear-gradient(135deg, #f3e8ff, #ede9fe); }
    .auth-card.manual     { border-color: #a0aec0; background: #f7fafc; }
    .auth-card.masterkey  { border-color: #e53e3e; background: linear-gradient(135deg, #fff5f5, #fed7d7); }

    .auth-card .icon  { font-size: 2rem; display: block; margin-bottom: 8px; }
    .auth-card .label { font-size: 0.8rem; font-weight: 600; color: #4a5568; }
    .auth-card .tier  { font-size: 0.7rem; color: #718096; margin-top: 2px; }

    .divider {
      display: flex;
      align-items: center;
      margin: 16px 0;
      color: #a0aec0;
      font-size: 0.8rem;
    }
    .divider::before, .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #e2e8f0;
    }
    .divider span { padding: 0 12px; }

    .manual-form { display: none; }
    .manual-form.active { display: block; }

    .form-group { margin-bottom: 16px; }

    .form-group label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: #4a5568;
      margin-bottom: 6px;
    }

    .form-group input {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #2d3748;
      transition: border-color 0.2s;
      outline: none;
    }

    .form-group input:focus { border-color: #667eea; }

    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }

    .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .btn-link {
      background: none;
      border: none;
      color: #667eea;
      font-size: 0.8rem;
      cursor: pointer;
      text-decoration: underline;
      padding: 0;
      width: auto;
    }

    .back-link {
      text-align: center;
      margin-top: 12px;
    }

    .footer {
      text-align: center;
      margin-top: 24px;
      font-size: 0.75rem;
      color: #a0aec0;
    }

    .roma-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .roma-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #68d391;
      animation: pulse 2s infinite;
    }

    .roma-dot.unverified { background: #f6ad55; animation: none; }
    .roma-dot.blocked    { background: #fc8181; animation: none; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @media (max-width: 480px) {
      .auth-methods { grid-template-columns: 1fr 1fr; }
      .login-container { padding: 24px; }
    }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="logo">
      <h1>TruAi</h1>
      <p>Secure AI Assistant</p>
    </div>

    <div id="status" class="status-msg" role="alert" aria-live="polite"></div>

    <!-- UBSAS 4-Tier Authentication Cards -->
    <div class="auth-methods" id="auth-methods">
      <div class="auth-card biometric disabled" id="card-biometric" onclick="attemptBiometric()" role="button" tabindex="0" aria-label="Biometric login">
        <span class="icon">ğŸ‘†</span>
        <div class="label">Biometric</div>
        <div class="tier">Tier 1 Â· Touch ID / Face ID</div>
      </div>

      <div class="auth-card autofill disabled" id="card-autofill" onclick="attemptAutoFill()" role="button" tabindex="0" aria-label="Auto-fill login">
        <span class="icon">ğŸ”‘</span>
        <div class="label">Auto-Fill</div>
        <div class="tier">Tier 2 Â· Keychain</div>
      </div>

      <div class="auth-card manual" id="card-manual" onclick="showManualForm()" role="button" tabindex="0" aria-label="Manual password login">
        <span class="icon">âŒ¨ï¸</span>
        <div class="label">Password</div>
        <div class="tier">Tier 3 Â· Always available</div>
      </div>

      <div class="auth-card masterkey" id="card-masterkey" onclick="showMasterKeyForm()" role="button" tabindex="0" aria-label="Master key recovery">
        <span class="icon">ğŸ”</span>
        <div class="label">Master Key</div>
        <div class="tier">Tier 4 Â· Emergency</div>
      </div>
    </div>

    <!-- Manual Login Form -->
    <div class="manual-form" id="form-manual">
      <div class="divider"><span>Password Login</span></div>
      <form onsubmit="submitManualLogin(event)">
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" id="username" name="username" autocomplete="username" required placeholder="Enter username">
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" name="password" autocomplete="current-password" required placeholder="Enter password">
        </div>
        <button type="submit" class="btn btn-primary" id="btn-login">Sign In</button>
      </form>
      <div class="back-link">
        <button class="btn-link" onclick="hideAllForms()">â† Back to options</button>
        &nbsp;Â·&nbsp;
        <a href="secure-recovery.html" style="font-size:0.8rem; color:#667eea;">Forgot password?</a>
      </div>
    </div>

    <!-- Master Key Form -->
    <div class="manual-form" id="form-masterkey">
      <div class="divider"><span>Master Key Recovery</span></div>
      <form onsubmit="submitMasterKey(event)">
        <div class="form-group">
          <label for="mk-username">Username</label>
          <input type="text" id="mk-username" name="username" autocomplete="username" required placeholder="Enter username">
        </div>
        <div class="form-group">
          <label for="master-key">Master Recovery Key</label>
          <input type="password" id="master-key" name="master_key" required placeholder="Enter 64-character recovery key" minlength="16">
        </div>
        <button type="submit" class="btn btn-primary" id="btn-masterkey">Recover Access</button>
      </form>
      <div class="back-link">
        <button class="btn-link" onclick="hideAllForms()">â† Back to options</button>
      </div>
    </div>

    <!-- Temp Password Modal -->
    <div class="manual-form" id="form-temppass">
      <div class="divider"><span>Recovery Successful</span></div>
      <div class="form-group">
        <label>Temporary Password (expires in <span id="countdown">10:00</span>)</label>
        <input type="text" id="temp-password" readonly style="font-family:monospace; background:#f7fafc;">
        <button type="button" class="btn-link" style="margin-top:6px;" onclick="copyTempPassword()">ğŸ“‹ Copy to clipboard</button>
      </div>
      <p style="font-size:0.8rem;color:#c53030;margin-bottom:12px;">âš ï¸ You MUST change this password immediately after login.</p>
      <button class="btn btn-primary" onclick="redirectToLogin()">Go to Login</button>
    </div>

    <footer class="footer">
      <span class="roma-indicator">
        <span class="roma-dot" id="roma-dot"></span>
        <span id="roma-label">Roma â€¢ Checking...</span>
      </span>
    </footer>
  </div>

  <script>
    'use strict';

    const API = '/TruAi/api/v1';
    let countdownTimer = null;

    // â”€â”€ Status helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showStatus(type, message) {
      const el = document.getElementById('status');
      el.className = 'status-msg ' + type;
      el.textContent = message;
    }

    function clearStatus() {
      const el = document.getElementById('status');
      el.className = 'status-msg';
      el.textContent = '';
    }

    // â”€â”€ Form visibility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function hideAllForms() {
      ['form-manual', 'form-masterkey', 'form-temppass'].forEach(id => {
        document.getElementById(id).classList.remove('active');
      });
      document.getElementById('auth-methods').style.display = 'grid';
      clearStatus();
    }

    function showManualForm() {
      document.getElementById('auth-methods').style.display = 'none';
      ['form-masterkey', 'form-temppass'].forEach(id => document.getElementById(id).classList.remove('active'));
      document.getElementById('form-manual').classList.add('active');
      document.getElementById('username').focus();
      clearStatus();
    }

    function showMasterKeyForm() {
      document.getElementById('auth-methods').style.display = 'none';
      ['form-manual', 'form-temppass'].forEach(id => document.getElementById(id).classList.remove('active'));
      document.getElementById('form-masterkey').classList.add('active');
      document.getElementById('mk-username').focus();
      clearStatus();
    }

    // â”€â”€ Init: fetch available methods â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function init() {
      try {
        const res = await fetch(API + '/auth/methods', { credentials: 'include' });
        if (!res.ok) return;
        const data = await res.json();
        updateMethodAvailability(data.methods || []);
      } catch (_) {
        // Silently fail â€“ manual is always available
      }
      checkRomaStatus();
    }

    function updateMethodAvailability(methods) {
      const biometricAvail = methods.some(m => m.type === 'biometric' && m.available);
      const autofillAvail  = methods.some(m => m.type === 'autofill' && m.available);

      const cardBio  = document.getElementById('card-biometric');
      const cardAuto = document.getElementById('card-autofill');

      if (biometricAvail) cardBio.classList.remove('disabled');
      if (autofillAvail)  cardAuto.classList.remove('disabled');
    }

    // â”€â”€ ROMA status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function checkRomaStatus() {
      try {
        const res = await fetch(API + '/security/roma', { credentials: 'include' });
        const data = await res.json();
        const dot   = document.getElementById('roma-dot');
        const label = document.getElementById('roma-label');

        if (data.trust_state === 'VERIFIED') {
          dot.className = 'roma-dot';
          label.textContent = 'Roma \u2022 Portal protected \u2022 Monitor active';
        } else if (data.trust_state === 'BLOCKED') {
          dot.className = 'roma-dot blocked';
          label.textContent = 'Roma \u2022 Blocked \u2022 Too many failures';
        } else {
          dot.className = 'roma-dot unverified';
          label.textContent = 'Roma \u2022 Unverified';
        }
      } catch (_) {
        document.getElementById('roma-label').textContent = 'Roma \u2022 Offline';
      }
    }

    // â”€â”€ Biometric auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function attemptBiometric() {
      if (document.getElementById('card-biometric').classList.contains('disabled')) return;
      showStatus('info', '\uD83D\uDC46 Touch sensor to authenticate\u2026');
      try {
        const res = await fetch(API + '/auth/biometric', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ app: 'truai' })
        });
        const data = await res.json();
        if (data.success) {
          showStatus('success', '\u2705 Biometric verified! Redirecting\u2026');
          setTimeout(() => { window.location.href = '/TruAi/'; }, 1000);
        } else {
          showStatus('error', data.error || 'Biometric authentication failed');
        }
      } catch (err) {
        showStatus('error', 'Biometric unavailable. Please use password login.');
      }
    }

    // â”€â”€ Auto-fill auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function attemptAutoFill() {
      if (document.getElementById('card-autofill').classList.contains('disabled')) return;
      showStatus('info', '\uD83D\uDD11 Accessing keychain\u2026');
      try {
        const res = await fetch(API + '/auth/autofill', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ app: 'truai' })
        });
        const data = await res.json();
        if (data.success) {
          showStatus('success', '\u2705 Authenticated via keychain! Redirecting\u2026');
          setTimeout(() => { window.location.href = '/TruAi/'; }, 1000);
        } else {
          showStatus('error', data.error || 'Auto-fill authentication failed');
        }
      } catch (err) {
        showStatus('error', 'Auto-fill unavailable. Please use password login.');
      }
    }

    // â”€â”€ Manual login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function submitManualLogin(event) {
      event.preventDefault();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const btn = document.getElementById('btn-login');

      if (!username || !password) {
        showStatus('error', 'Username and password are required.');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Signing in\u2026';
      clearStatus();

      try {
        const csrfToken = await getCSRFToken();
        const res = await fetch(API + '/auth/login', {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken
          },
          body: JSON.stringify({ username, password })
        });

        const data = await res.json();

        if (data.success) {
          showStatus('success', '\u2705 Login successful! Redirecting\u2026');
          setTimeout(() => { window.location.href = '/TruAi/'; }, 800);
        } else if (res.status === 429) {
          showStatus('error', data.error || 'Too many attempts. Please wait before trying again.');
        } else {
          showStatus('error', data.error || 'Invalid username or password.');
        }
      } catch (err) {
        showStatus('error', 'Connection error. Please try again.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Sign In';
      }
    }

    // â”€â”€ Master key recovery â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function submitMasterKey(event) {
      event.preventDefault();
      const username  = document.getElementById('mk-username').value.trim();
      const masterKey = document.getElementById('master-key').value;
      const btn = document.getElementById('btn-masterkey');

      if (!username || !masterKey) {
        showStatus('error', 'Username and master key are required.');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Verifying\u2026';
      clearStatus();
      showStatus('info', '\uD83D\uDD10 Verifying master key with ROMA\u2026');

      try {
        const res = await fetch(API + '/auth/masterkey', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, master_key: masterKey })
        });

        const data = await res.json();

        if (data.success && data.temporary_password) {
          displayTempPassword(data.temporary_password, data.expires_at);
        } else if (res.status === 429) {
          showStatus('error', data.error || 'Too many recovery attempts. Wait 24 hours.');
        } else {
          showStatus('error', data.error || 'Invalid master key or username.');
        }
      } catch (err) {
        showStatus('error', 'Connection error. Please try again.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Recover Access';
      }
    }

    function displayTempPassword(tempPass, expiresAt) {
      document.getElementById('form-masterkey').classList.remove('active');
      document.getElementById('form-temppass').classList.add('active');
      document.getElementById('temp-password').value = tempPass;

      const secondsLeft = expiresAt
        ? Math.max(0, Math.floor((new Date(expiresAt) - Date.now()) / 1000))
        : 600;
      startCountdown(secondsLeft);
    }

    function startCountdown(seconds) {
      if (countdownTimer) clearInterval(countdownTimer);
      const display = document.getElementById('countdown');
      let remaining = seconds;

      const tick = () => {
        const m = Math.floor(remaining / 60);
        const s = remaining % 60;
        display.textContent = m + ':' + String(s).padStart(2, '0');
        if (remaining <= 0) {
          clearInterval(countdownTimer);
          showStatus('error', 'Temporary password expired. Please start recovery again.');
          setTimeout(() => hideAllForms(), 3000);
        }
        remaining--;
      };
      tick();
      countdownTimer = setInterval(tick, 1000);
    }

    function copyTempPassword() {
      const input = document.getElementById('temp-password');
      input.select();
      navigator.clipboard.writeText(input.value).catch(() => {
        document.execCommand('copy');
      });
      showStatus('info', '\uD83D\uDCCB Copied to clipboard!');
    }

    function redirectToLogin() {
      if (countdownTimer) clearInterval(countdownTimer);
      showManualForm();
    }

    // â”€â”€ CSRF token helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _csrfToken = null;
    async function getCSRFToken() {
      if (_csrfToken) return _csrfToken;
      try {
        const res = await fetch(API + '/auth/csrf-token', { credentials: 'include' });
        const data = await res.json();
        _csrfToken = data.csrf_token || '';
      } catch (_) {
        _csrfToken = '';
      }
      return _csrfToken;
    }

    // â”€â”€ Keyboard accessibility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        const target = e.target;
        if (target.classList.contains('auth-card') && !target.classList.contains('disabled')) {
          target.click();
        }
      }
    });

    // â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    init();
  </script>
</body>
</html>
