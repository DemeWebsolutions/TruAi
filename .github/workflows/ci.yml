name: TruAi CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  lint:
    name: PHP Syntax Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup PHP 8.2
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: sqlite3, openssl, mbstring, json
        coverage: none

    - name: Validate PHP syntax
      run: |
        echo "Checking PHP syntax in backend/..."
        find backend -name "*.php" -exec php -l {} \; || exit 1

        echo "Checking PHP syntax in scripts/..."
        find scripts -name "*.php" -exec php -l {} \; || exit 1

    - name: Check for common security issues
      run: |
        echo "Checking for exposed secrets..."
        ! grep -r "sk-[a-zA-Z0-9]\{48\}" backend/ scripts/ || (echo "OpenAI API key found in code!" && exit 1)
        ! grep -r "sk-ant-[a-zA-Z0-9]\{48\}" backend/ scripts/ || (echo "Anthropic API key found in code!" && exit 1)

        echo "Checking file permissions..."
        [ ! -f database/.initial_credentials ] || [ "$(stat -c %a database/.initial_credentials 2>/dev/null || echo 600)" = "600" ]

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup PHP 8.2
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: sqlite3, openssl, mbstring, json

    - name: Create .env file
      run: |
        cat > .env <<EOF
        TRUAI_DEPLOYMENT=testing
        OPENAI_API_KEY=sk-test-key-not-real
        ANTHROPIC_API_KEY=sk-ant-test-key-not-real
        EOF

    - name: Initialize database
      run: |
        php scripts/setup_database.php

    - name: Run unit tests
      run: |
        php tests/run_tests.php

    - name: Check database integrity
      run: |
        sqlite3 database/truai.db "PRAGMA integrity_check;" | grep -q "ok" || exit 1
        echo "[OK] Database integrity check passed"

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup PHP 8.2
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: sqlite3, openssl, mbstring, json

    - name: Create .env file
      run: |
        cat > .env <<EOF
        TRUAI_DEPLOYMENT=testing
        OPENAI_API_KEY=sk-test-key-not-real
        ANTHROPIC_API_KEY=sk-ant-test-key-not-real
        EOF

    - name: Initialize database
      run: php scripts/setup_database.php

    - name: Start PHP dev server
      run: |
        php -S 127.0.0.1:8001 router.php > /tmp/php_server.log 2>&1 &
        echo $! > /tmp/php_server.pid
        sleep 2

    - name: Health check
      run: |
        curl -f http://127.0.0.1:8001/TruAi/api/v1/health || (cat /tmp/php_server.log && exit 1)

    - name: Test ROMA endpoint
      run: |
        curl -s http://127.0.0.1:8001/TruAi/api/v1/security/roma | grep -q '"roma"' || exit 1
        echo "[OK] ROMA endpoint responsive"

    - name: Test login endpoint (expect failure without creds)
      run: |
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
          -X POST http://127.0.0.1:8001/TruAi/api/v1/auth/login \
          -H "Content-Type: application/json" \
          -d '{"username":"test","password":"test"}')

        [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "401" ] || [ "$HTTP_CODE" = "400" ] || exit 1
        echo "[OK] Login endpoint responsive"

    - name: Cleanup
      if: always()
      run: |
        [ -f /tmp/php_server.pid ] && kill $(cat /tmp/php_server.pid) || true

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Check for sensitive files
      run: |
        echo "Checking for sensitive files in repository..."
        [ ! -f database/.initial_credentials ] || (echo ".initial_credentials should not be committed!" && exit 1)
        [ ! -f database/truai.db ] || (echo "Database should not be committed!" && exit 1)
        [ ! -f .env ] || (echo ".env should not be committed!" && exit 1)
        echo "[OK] No sensitive files found"

    - name: Check CORS configuration
      run: |
        grep -q "localhost:8001" backend/config.php || (echo "Port 8001 not in CORS config!" && exit 1)
        grep -q "localhost:8001" backend/router.php || (echo "Port 8001 not in router CORS!" && exit 1)
        echo "[OK] CORS configuration includes port 8001"

    - name: Verify Argon2id usage
      run: |
        grep -q "PASSWORD_ARGON2ID" backend/config.php || (echo "Argon2id not configured!" && exit 1)
        grep -q "ARGON2ID_OPTIONS" backend/config.php || (echo "Argon2id options not set!" && exit 1)
        echo "[OK] Argon2id password hashing configured"
