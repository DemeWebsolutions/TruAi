<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gemini.ai — Login &amp; Dashboard</title>
  <script>
    window.TRUAI_CONFIG = {
      API_BASE: (window.location.origin + '/TruAi/api/v1').replace(/\/TruAi\/TruAi/, '/TruAi'),
      CSRF_TOKEN: '',
      IS_AUTHENTICATED: false,
      USERNAME: ''
    };
  </script>
  <script src="/TruAi/assets/js/crypto.js"></script>
  <script src="/TruAi/assets/js/api.js"></script>
  <style>
    /* ========== LOGIN (gemini-login-logo-style — unchanged) ========== */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      color: #B3B3B3;
      min-height: 100vh;
      margin: 0;
    }

    /* Login view */
    #login-view {
      background: #292929;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .login-container {
      background: rgba(42, 42, 42, 0.95);
      border-radius: 12px;
      padding: 40px;
      max-width: 420px;
      width: 100%;
      border: 1px solid #4A4A4A;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
    }

    .logo {
      text-align: center;
      margin-bottom: 24px;
    }

    .logo img {
      max-width: 300px;
      height: auto;
    }

    .logo h1 {
      font-size: 24px;
      font-weight: 600;
      color: #A0A0A0;
      letter-spacing: 0.02em;
    }

    .logo p {
      color: #696969;
      font-size: 12px;
      margin-top: 4px;
    }

    .legal-notice {
      background: rgba(0, 0, 0, 0.3);
      border-left: 2px solid #00A3FF;
      border-right: 2px solid #00A3FF;
      padding: 12px 14px;
      margin-bottom: 22px;
      border-radius: 8px;
      font-size: 11px;
      line-height: 1.5;
      color: #A0A0A0;
    }

    .legal-notice strong { color: #FFFFFF; }

    .form-group { margin-bottom: 18px; }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #A0A0A0;
      font-size: 13px;
    }

    .form-group input {
      width: 100%;
      padding: 11px 12px;
      background: #1A1A1A;
      border: 1px solid #4A4A4A;
      border-radius: 8px;
      color: #FFFFFF;
      font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #00A3FF;
      box-shadow: 0 0 0 1px rgba(0, 163, 255, 0.4);
    }

    .form-group input::placeholder {
      color: #696969;
    }

    .footer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
      font-size: 12px;
      color: #696969;
    }

    .footer-row a {
      color: #00A3FF;
      text-decoration: none;
    }

    .footer-row a:hover { color: #FFFFFF; text-decoration: underline; }

    .btn-primary {
      width: 100%;
      padding: 12px 0;
      border-radius: 8px;
      border: none;
      background: #00A3FF;
      color: #FFFFFF;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }

    .btn-primary:hover {
      background: #0088DD;
      transform: translateY(-1px);
    }

    .btn-primary:active { transform: translateY(0); }

    .copyright {
      margin-top: 20px;
      font-size: 11px;
      color: #696969;
      text-align: center;
    }

    .copyright a {
      color: #00A3FF;
      text-decoration: none;
    }

    .copyright a:hover { color: #FFFFFF; }

    .roma-indicator {
      position: fixed;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: rgba(255,255,255,0.5);
      letter-spacing: 0.05em;
      z-index: 100;
    }
    .roma-indicator.confirmed { color: rgba(255,255,255,0.75); }

    /* Disclaimer view (shown after login, before dashboard) */
    #disclaimer-view {
      background: #292929;
      min-height: 100vh;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      color: #e5e7eb;
    }

    .disclaimer-card {
      max-width: 640px;
      width: 100%;
      background: rgba(15, 17, 20, 0.96);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7);
      padding: 28px 28px 22px;
    }

    .disclaimer-card h2 {
      margin: 0 0 12px 0;
      font-size: 20px;
      font-weight: 600;
      color: #fbbf24;
    }

    .disclaimer-card p {
      font-size: 13px;
      line-height: 1.6;
      margin: 6px 0;
      color: #d1d5db;
    }

    .disclaimer-card p strong {
      color: #f9fafb;
    }

    .disclaimer-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 18px;
    }

    .disclaimer-actions button {
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 600;
      border: none;
      cursor: pointer;
    }

    .disclaimer-actions .btn-secondary {
      background: #4b5563;
      color: #e5e7eb;
    }

    .disclaimer-actions .btn-secondary:hover {
      background: #374151;
    }

    .disclaimer-actions .btn-primary-continue {
      background: #00A3FF;
      color: #ffffff;
    }

    .disclaimer-actions .btn-primary-continue:hover {
      background: #0088DD;
    }

    /* ========== DASHBOARD (gemini-login-dashboard-with-logo) ========== */
    #dashboard-view {
      display: none;
      min-height: 100vh;
      color: #ffffff;
      background:
        radial-gradient(1200px 600px at 50% 100%, rgba(0,0,0,0.55), rgba(0,0,0,0.85)),
        #1a1a1a;
    }

    #dashboard-view.active {
      display: block;
    }

    :root {
      --blue: #1ea7ff;
      --white: #ffffff;
      --glass-bg: rgba(15,17,20,0.6);
      --glass-border: rgba(255,255,255,0.12);
      --shadow: 0 10px 25px rgba(0,0,0,0.35);
    }

    .overlay {
      position: fixed;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(700px 350px at 50% 0%, rgba(30,167,255,0.08), transparent),
        radial-gradient(1000px 500px at 10% 80%, rgba(255,255,255,0.05), transparent);
      mix-blend-mode: screen;
    }

    #dashboard-view a { color: var(--blue); text-decoration: none; }
    #dashboard-view a:hover { text-decoration: underline; }

    #dashboard-view button, #dashboard-view .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 12px 18px;
      border-radius: 8px;
      border: 1px solid var(--blue);
      background: linear-gradient(180deg, rgba(30,167,255,0.25), rgba(30,167,255,0.15));
      color: var(--white);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }

    #dashboard-view button:hover, #dashboard-view .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(30,167,255,0.3);
      background: linear-gradient(180deg, rgba(30,167,255,0.35), rgba(30,167,255,0.22));
    }

    #dashboard-view .btn-outline {
      background: transparent;
      border-color: var(--white);
      color: var(--white);
    }

    .center {
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 24px;
    }

    .shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 25px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      backdrop-filter: saturate(125%) blur(10px);
      -webkit-backdrop-filter: saturate(125%) blur(10px);
      box-shadow: var(--shadow);
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
      margin-bottom: 24px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand .logo-img {
      height: 80px;
      object-fit: contain;
      padding-right: 5px;
      padding-left: 5px;
      width: 90px;
    }

    .brand h1 { font-size: 24px; font-weight: 600; margin: 0; letter-spacing: 0.02em; color: #A0A0A0; }

    .muted { color: #696969; font-size: 12px; }

    .nav a {
      padding: 11px 14px;
      border-radius: 8px;
      border: 1px solid transparent;
      font-size: 13px;
    }

    .nav a:hover {
      border-color: var(--blue);
      background: linear-gradient(180deg, rgba(30,167,255,0.18), rgba(30,167,255,0.06));
    }
    .nav-tab.active {
      border-color: var(--blue);
      background: linear-gradient(180deg, rgba(30,167,255,0.18), rgba(30,167,255,0.06));
    }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    .chat-history { max-height: 320px; overflow-y: auto; margin-bottom: 12px; }
    .chat-msg { margin-bottom: 10px; font-size: 13px; line-height: 1.5; }
    .chat-msg.user { text-align: right; }
    .chat-msg.user span { display: inline-block; background: rgba(30,167,255,0.2); border-radius: 12px; padding: 8px 12px; }
    .chat-msg.ai span { display: inline-block; background: rgba(255,255,255,0.06); border-radius: 12px; padding: 8px 12px; border: 1px solid var(--glass-border); }
    .chat-msg.ai .md-content { white-space: pre-wrap; word-break: break-word; }
    .chat-msg.ai .md-content strong { font-weight: 600; color: #e8e9eb; }
    .chat-msg.ai .md-content ul, .chat-msg.ai .md-content ol { margin: 6px 0; padding-left: 20px; }
    .chat-msg.ai .md-content li { margin: 2px 0; }
    .chat-msg-wrap { position: relative; }
    .chat-feedback { display: flex; gap: 4px; margin-top: 4px; opacity: 0.7; align-items: center; flex-wrap: wrap; }
    .chat-feedback button { background: none; border: none; color: #A0A0A0; cursor: pointer; padding: 2px 6px; font-size: 12px; }
    .chat-feedback button:hover { color: var(--blue); }
    .chat-feedback button.feedback-done { opacity: 0.5; cursor: default; }
    .chat-feedback .chat-action-btn { padding: 4px 6px; border-radius: 4px; }
    .chat-feedback .chat-action-btn svg { width: 14px; height: 14px; vertical-align: middle; opacity: 0.8; }
    .chat-history-header { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
    .chat-history-btn { padding: 6px 12px; font-size: 12px; border-radius: 6px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.04); color: #A0A0A0; cursor: pointer; }
    .chat-history-btn:hover { border-color: var(--blue); color: var(--blue); }
    .chat-past-dropdown { position: relative; }
    .chat-past-list { display: none; position: absolute; top: 100%; left: 0; margin-top: 4px; min-width: 200px; max-height: 240px; overflow-y: auto; background: rgba(20,22,26,0.98); border: 1px solid var(--glass-border); border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); z-index: 100; }
    .chat-past-list.open { display: block; }
    .chat-past-list .chat-past-item { display: block; width: 100%; padding: 10px 12px; font-size: 12px; color: #e8e9eb; text-align: left; background: none; border: none; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.06); }
    .chat-past-list .chat-past-item:last-child { border-bottom: none; }
    .chat-past-list .chat-past-item:hover { background: rgba(30,167,255,0.1); }
    .chat-past-item { display: flex !important; align-items: center; justify-content: space-between; gap: 8px; }
    .chat-past-item .chat-past-title { flex: 1; min-width: 0; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; cursor: pointer; }
    .chat-past-item .chat-past-delete { flex-shrink: 0; padding: 2px 6px; font-size: 14px; line-height: 1; background: none; border: none; color: #696969; cursor: pointer; border-radius: 4px; }
    .chat-past-item .chat-past-delete:hover { color: #ff6b6b; background: rgba(255,107,107,0.1); }
    .chat-past-list .chat-past-item.selected { color: var(--blue); }
    .chat-past-list .chat-past-empty { padding: 12px; font-size: 12px; color: #A0A0A0; }
    .chat-suggestions { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
    .chat-suggestions .suggest-btn { padding: 6px 12px; font-size: 12px; border-radius: 6px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.04); color: #A0A0A0; cursor: pointer; }
    .chat-suggestions .suggest-btn:hover { border-color: var(--blue); color: var(--white); background: rgba(30,167,255,0.1); }
    .insight-card { display: flex; flex-direction: column; align-items: center; background: rgba(255,255,255,0.04); border: 1px solid var(--glass-border); border-radius: 8px; padding: 14px; margin-bottom: 12px; }
    .insight-card .insight-icon { flex-shrink: 0; width: 92px; height: 92px; object-fit: contain; }
    .insight-card .insight-body { width: 100%; text-align: center; margin-top: 8px; }
    .insight-card.priority-high {
      border-left: 3px solid var(--blue);
      border-right: 3px solid var(--blue);
    }
    .insight-card.priority-medium {
      border-left: 3px solid var(--blue);
      border-right: 3px solid var(--blue);
    }
    .insight-card.priority-low {
      border-left: 3px solid var(--blue);
      border-right: 3px solid var(--blue);
    }
    .insight-card h3 { font-size: 14px; font-weight: 600; color: #e8e9eb; margin: 0 0 6px 0; }
    .insight-card p { font-size: 12px; color: #A0A0A0; margin: 0 0 10px 0; line-height: 1.5; }
    .alert-item { display: flex; flex-direction: column; align-items: center; padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.08); margin-bottom: 8px; cursor: pointer; transition: background 0.2s; }
    .alert-item:hover { background: rgba(255,255,255,0.06); }
    .alert-item.severity-high {
      border-left: 3px solid var(--blue);
      border-right: 3px solid var(--blue);
    }
    .alert-item.severity-low {
      border-left: 3px solid var(--blue);
      border-right: 3px solid var(--blue);
    }
    .alert-item.severity-medium {
      border-left: 3px solid var(--blue);
      border-right: 3px solid var(--blue);
    }
    .alert-item .alert-icon { flex-shrink: 0; width: 92px; height: 92px; object-fit: contain; }
    .alert-item .alert-body { width: 100%; text-align: center; margin-top: 8px; }
    .alert-item .alert-msg { font-size: 13px; color: #e8e9eb; }
    .alert-item .alert-meta { font-size: 11px; color: #696969; margin-top: 4px; }
    .chat-input-row { display: flex; gap: 8px; margin-top: 8px; }
    .chat-input-row textarea { flex: 1; min-height: 44px; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.06); color: #fff; font-size: 13px; resize: none; }
    .chat-escalation { margin-top: 8px; }
    .chat-escalation-link { font-size: 12px; color: var(--blue); text-decoration: none; }
    .chat-escalation-link:hover { text-decoration: underline; }
    .chat-input-row button { padding: 10px 18px; border-radius: 8px; border: 1px solid var(--blue); background: linear-gradient(180deg, rgba(30,167,255,0.3), rgba(30,167,255,0.15)); color: #fff; font-weight: 600; cursor: pointer; }
    .chat-api-settings { margin-top: 12px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px solid var(--glass-border); }
    .chat-api-settings-toggle { background: none; border: none; color: var(--blue); font-size: 12px; cursor: pointer; padding: 0; margin-bottom: 8px; }
    .chat-api-settings-toggle:hover { text-decoration: underline; }
    .chat-api-settings-panel { display: none; }
    .chat-api-settings-panel.open { display: block; }
    .chat-api-settings-panel .form-group { margin-bottom: 10px; }
    .chat-api-settings-panel label { display: block; font-size: 12px; color: #A0A0A0; margin-bottom: 4px; }
    .chat-api-settings-panel input { width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.06); color: #fff; font-size: 13px; }
    .chat-api-settings-panel .btn-row { display: flex; gap: 8px; margin-top: 10px; }
    .chat-api-settings-panel .btn-row button { padding: 8px 14px; font-size: 12px; }

    .grid {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(12, 1fr);
    }

    .card-sm {
      grid-column: span 3;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      padding: 18px;
    }

    .card-lg {
      grid-column: span 12;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      padding: 22px;
    }

    .stat { font-size: 13px; font-weight: 600; color: #A0A0A0; margin-bottom: 6px; }

    .value { font-size: 24px; font-weight: 600; color: var(--white); }

    .actions { display: flex; gap: 12px; flex-wrap: wrap; }

    .footer {
      margin-top: 20px;
      color: #696969;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .footer .dw {
      color: var(--blue);
      font-weight: 700;
      border-bottom: 1px solid var(--blue);
    }

    @media (max-width: 900px) {
      .card-sm { grid-column: span 6; }
    }

    @media (max-width: 600px) {
      .card-sm { grid-column: span 12; }
    }

    @media (prefers-reduced-motion: reduce) {
      * { transition: none !important; }
    }
  </style>
</head>
<body>
  <!-- Login (gemini-login-logo-style — exactly the same) -->
  <div id="login-view">
    <div class="login-container">
      <div class="logo">
        <img src="/TruAi/assets/Gemini.ai_Logo-e2c5fbfe-a528-4613-8631-3d094ab89f8e.png" alt="Gemini.ai">
        <h1>Gemini.ai</h1>
        <p>AI-Powered Server Management Portal</p>
      </div>

      <div class="legal-notice">
        <strong>PROPRIETARY SYSTEM</strong><br>
        © 2013 – <script>document.write(new Date().getFullYear())</script> My Deme, LLC. All Rights Reserved.<br>
        Unauthorized access or use is strictly prohibited and may result in civil and criminal penalties.
      </div>

      <form id="loginForm">
        <div class="form-group">
          <label for="username">Portal Username</label>
          <input id="username" name="username" type="text" placeholder="Username" autocomplete="username" required>
        </div>
        <div class="form-group">
          <label for="password">Portal Password</label>
          <input id="password" name="password" type="password" placeholder="Password" autocomplete="current-password" required>
        </div>

        <div class="footer-row">
          <span>My Deme, LLC • Florida, USA</span>
          <a href="#" id="forgotPasswordLink">Forgot password?</a>
        </div>

        <button type="submit" class="btn-primary">Sign in</button>
      </form>

      <div class="copyright">
        <a href="/TruAi">Return to TruAi</a>
        <span style="margin:0 8px">|</span>
        <a href="https://demewebsolutions.com" target="_blank">DEMEWEBSOLUTIONS.COM</a> • WEB SOLUTIONS MADE SIMPLE
      </div>
    </div>
    <div id="romaLogin" class="roma-indicator">Roma • Checking…</div>
  </div>

  <!-- Disclaimer (shown after successful login, before dashboard) -->
  <div id="disclaimer-view">
    <div class="disclaimer-card" role="dialog" aria-labelledby="disclaimer-title" aria-modal="true">
      <h2 id="disclaimer-title">⚠️ Proprietary System Notice</h2>
      <p><strong>© 2013 – 2026 My Deme, LLC. All Rights Reserved.</strong></p>
      <p>
        This Gemini.ai system, including all software, data, configurations, and operational workflows,
        is the exclusive property of My Deme, LLC. Access is permitted only for authorized personnel
        acting within the scope of their duties.
      </p>
      <p>
        By selecting <strong>“I Understand and Accept”</strong>, you acknowledge that this system is
        protected under <strong>Florida State Law</strong> and <strong>United States Federal Law</strong>,
        and that <strong>unauthorized access, use, or disclosure is strictly prohibited</strong> and may
        result in civil and criminal penalties.
      </p>
      <p>
        All access attempts may be monitored and logged for security and compliance purposes.
      </p>
      <div class="disclaimer-actions">
        <a href="/TruAi" class="btn-secondary" style="text-decoration:none;display:inline-flex;align-items:center;padding:10px 16px;">Return to TruAi</a>
        <button type="button" id="disclaimerCancel" class="btn-secondary">Cancel / Return to Login</button>
        <button type="button" id="disclaimerAccept" class="btn-primary-continue">I Understand and Accept</button>
      </div>
    </div>
  </div>

  <!-- Dashboard (gemini-login-dashboard-with-logo) -->
  <div id="dashboard-view">
    <div class="overlay" aria-hidden="true"></div>
    <div class="center" style="padding-top: 3rem">
      <div class="shell">
        <div class="topbar">
          <div class="brand">
            <img class="logo-img" src="/TruAi/assets/Gemini.ai_Logo-e2c5fbfe-a528-4613-8631-3d094ab89f8e.png" alt="Gemini.ai">
            <h1 style="margin:0">Gemini.ai Dashboard</h1>
          </div>
            <nav class="nav" aria-label="Primary">
            <a href="#" data-tab="overview" class="nav-tab active">Overview</a>
            <a href="#" data-tab="insights" class="nav-tab">AI Insights</a>
            <a href="#" data-tab="provisioning" class="nav-tab">Provisioning</a>
            <a href="#" data-tab="diagnostics" class="nav-tab">Diagnostics</a>
            <a href="#" data-tab="security" class="nav-tab">Security</a>
            <a href="#" data-tab="chat" class="nav-tab">AI Chat</a>
            <a href="/TruAi" class="nav-tab">Return to TruAi</a>
            <a href="#" id="signOut">Sign out</a>
          </nav>
        </div>

        <div id="tab-overview" class="tab-panel active">
          <div class="grid">
            <div class="card-sm">
              <div class="stat">Provisioned Nodes</div>
              <div class="value" id="statNodes">—</div>
            </div>
            <div class="card-sm">
              <div class="stat">Active Alerts</div>
              <div class="value" id="statAlerts" style="color:rgba(30, 167, 255, 0.5)">—</div>
            </div>
            <div class="card-sm">
              <div class="stat">Avg CPU Load</div>
              <div class="value" id="statCpu">—</div>
            </div>
            <div class="card-sm">
              <div class="stat">Uptime</div>
              <div class="value" id="statUptime">—</div>
            </div>
            <div class="card-lg">
              <h2 style="margin:0 0 12px 0; font-size:18px; font-weight:600; color:#A0A0A0">Automation &amp; Actions</h2>
              <p class="muted" style="margin-bottom:18px">Run common tasks with one click. Links and buttons use the Gemini blue/white scheme.</p>
              <div class="actions">
                <button class="action-btn" data-action="Run Diagnostics">Run Diagnostics</button>
                <button class="action-btn" data-action="Apply Security Hardening">Apply Security Hardening</button>
                <button class="action-btn" data-action="Scale Cluster">Scale Cluster</button>
                <button class="btn btn-outline">View Logs</button>
                <a class="btn" href="#">Open Task Scheduler</a>
              </div>
            </div>
            <div class="card-lg">
              <h2 style="margin:0 0 12px 0; font-size:18px; font-weight:600; color:#A0A0A0">Recent Activity</h2>
              <ul style="margin:0; padding:0; list-style:none" id="activityList">
                <li style="padding:10px 0; font-size:13px; color:#696969">Loading…</li>
              </ul>
            </div>
            <div class="card-lg">
              <h2 style="margin:0 0 12px 0; font-size:18px; font-weight:600; color:#A0A0A0">Active Alerts</h2>
              <p class="muted" style="margin-bottom:12px">Click an alert for details and remediation.</p>
              <div id="alertsList"></div>
            </div>
            <div class="card-lg">
              <h2 style="margin:0 0 12px 0; font-size:18px; font-weight:600; color:#A0A0A0">Usage &amp; Cost</h2>
              <p class="muted" style="margin-bottom:12px">API usage and cost estimate for the last 30 days.</p>
              <div style="display:flex; gap:24px; flex-wrap:wrap;">
                <div><span class="stat">API Calls</span><div class="value" id="usageCalls">—</div></div>
                <div><span class="stat">Tokens (est.)</span><div class="value" id="usageTokens">—</div></div>
                <div><span class="stat">Cost Estimate</span><div class="value" id="usageCost">—</div></div>
              </div>
            </div>
          </div>
        </div>
        <div id="tab-insights" class="tab-panel">
          <div class="card-lg">
            <h2 style="margin:0 0 12px 0; font-size:18px; font-weight:600; color:#A0A0A0">AI Insights</h2>
            <p class="muted" style="margin-bottom:18px">Proactive recommendations based on metrics and patterns. Powered by TruAi Core.</p>
            <div id="insightsList"></div>
          </div>
          <div class="card-lg">
            <h2 style="margin:0 0 12px 0; font-size:18px; font-weight:600; color:#A0A0A0">Suggested Actions</h2>
            <p class="muted" style="margin-bottom:12px">AI suggests these actions based on current state.</p>
            <div class="actions" id="suggestedActionsList"></div>
          </div>
        </div>
        <div id="tab-provisioning" class="tab-panel">
          <div class="card-lg">
            <h2 style="margin:0 0 12px 0; font-size:18px; font-weight:600; color:#A0A0A0">Provisioning</h2>
            <p class="muted" style="margin-bottom:18px">Provision new nodes, scale clusters, and manage deployments.</p>
            <div class="actions">
              <button class="action-btn" data-action="Provision Node">Provision Node</button>
              <button class="action-btn" data-action="Scale Cluster">Scale Cluster</button>
            </div>
          </div>
        </div>
        <div id="tab-diagnostics" class="tab-panel">
          <div class="card-lg">
            <h2 style="margin:0 0 12px 0; font-size:18px; font-weight:600; color:#A0A0A0">Diagnostics</h2>
            <p class="muted" style="margin-bottom:18px">Run health checks, collect logs, and troubleshoot issues.</p>
            <div class="actions">
              <button class="action-btn" data-action="Run Diagnostics">Run Full Diagnostics</button>
              <button class="action-btn" data-action="Collect Logs">Collect Logs</button>
            </div>
          </div>
        </div>
        <div id="tab-security" class="tab-panel">
          <div class="card-lg">
            <h2 style="margin:0 0 12px 0; font-size:18px; font-weight:600; color:#A0A0A0">Security Center</h2>
            <p class="muted" style="margin-bottom:18px">Access policies, roles, and audit controls. Protected under Florida State Law and United States Federal Law.</p>
            <div class="actions">
              <button class="action-btn" data-action="Apply Security Hardening">Apply Security Hardening</button>
              <button class="action-btn" data-action="Rotate Keys">Rotate API Keys</button>
              <button class="action-btn" id="geminiChangePasswordBtn">Change Password</button>
              <a href="/TruAi" class="btn btn-outline">Open TruAi Settings</a>
            </div>
          </div>
        </div>
        <div id="tab-chat" class="tab-panel">
          <div class="card-lg">
            <h2 style="margin:0 0 12px 0; font-size:18px; font-weight:600; color:#A0A0A0">AI Chat</h2>
            <p class="muted" style="margin-bottom:12px">Ask Gemini.ai to run tasks, explain metrics, or inspect nodes. Powered by TruAi Core.</p>
            <div class="chat-history-header">
              <button type="button" id="chatNewChat" class="chat-history-btn" title="Start new chat">New chat</button>
              <div class="chat-past-dropdown">
                <button type="button" id="chatPastToggle" class="chat-history-btn" title="Previous chats">Past chats ▾</button>
                <div id="chatPastList" class="chat-past-list"></div>
              </div>
            </div>
            <div class="chat-suggestions" id="chatSuggestions">
              <button type="button" class="suggest-btn" data-prompt="Run diagnostics on node gmn-07">Run diagnostics on node gmn-07</button>
              <button type="button" class="suggest-btn" data-prompt="Explain current CPU load across all nodes">Explain CPU load</button>
              <button type="button" class="suggest-btn" data-prompt="List active alerts and suggest remediation">List active alerts</button>
              <button type="button" class="suggest-btn" data-prompt="Scale cluster by 2 nodes">Scale cluster</button>
            </div>
            <div class="chat-history" id="chatHistory">
              <div class="chat-msg-wrap">
                <div class="chat-msg ai"><span>Hello. How can Gemini.ai assist you today?</span></div>
                <div class="chat-feedback">
                  <button type="button" class="chat-action-btn chat-copy" title="Copy" aria-label="Copy"><svg fill="currentColor" viewBox="0 0 24 24" width="14" height="14"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>
                  <button type="button" class="chat-action-btn chat-send" title="Send to input" aria-label="Send to input"><svg fill="currentColor" viewBox="0 0 24 24" width="14" height="14"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
                  <button type="button" class="chat-action-btn chat-share" title="Share" aria-label="Share"><svg fill="currentColor" viewBox="0 0 24 24" width="14" height="14"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92 0-.22-.03-.44-.08-.65l7.12-4.16c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3z"/></svg></button>
                </div>
              </div>
            </div>
            <div class="chat-input-row">
              <textarea id="chatInput" placeholder="Ask Gemini.ai to run a task, explain a metric, or inspect a node…" rows="2"></textarea>
              <button type="button" id="chatSend">Send</button>
            </div>
            <div class="chat-escalation">
              <a href="/TruAi" class="chat-escalation-link" title="Escalate to TruAi Core for governance review">Request TruAi review</a>
            </div>
            <div class="chat-api-settings">
              <button type="button" class="chat-api-settings-toggle" id="chatApiSettingsToggle">API Settings</button>
              <div class="chat-api-settings-panel" id="chatApiSettingsPanel">
                <div class="form-group">
                  <label for="chatApiBase">API Base URL</label>
                  <input type="text" id="chatApiBase" placeholder="e.g. https://example.com/TruAi/api/v1">
                </div>
                <div class="form-group">
                  <label for="chatOpenaiApiKey">OpenAI API Key</label>
                  <input type="password" id="chatOpenaiApiKey" placeholder="sk-..." autocomplete="off">
                </div>
                <div class="form-group">
                  <label for="chatSonnetApiKey">Sonnet (Anthropic) API Key</label>
                  <input type="password" id="chatSonnetApiKey" placeholder="sk-ant-..." autocomplete="off">
                </div>
                <div class="btn-row">
                  <button type="button" id="chatApiSave">Save</button>
                  <button type="button" id="chatApiTest">Test all keys</button>
                  <button type="button" id="chatApiReset" class="btn-outline">Reset to default</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="footer">
          <span>© 2025 - 2026 My Deme, LLC. All Rights Reserved. | Gemini.ai</span>
          <span>| Protected under Florida State Law and United States Federal Law</span>
          <span>| PROPRIETARY AND CONFIDENTIAL</span>
        </div>
        <div id="romaDashboard" class="roma-indicator" style="position:relative;bottom:auto;left:auto;transform:none;margin-top:12px">Roma • Checking…</div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      var saved = localStorage.getItem('gemini-api-base');
      if (saved && saved.trim() && window.TRUAI_CONFIG) {
        window.TRUAI_CONFIG.API_BASE = saved.trim();
      }
    })();
    const loginForm = document.getElementById('loginForm');
    const loginView = document.getElementById('login-view');
    const dashboardView = document.getElementById('dashboard-view');
    const disclaimerView = document.getElementById('disclaimer-view');
    const disclaimerAccept = document.getElementById('disclaimerAccept');
    const disclaimerCancel = document.getElementById('disclaimerCancel');
    const signOut = document.getElementById('signOut');
    const api = typeof TruAiAPI !== 'undefined' ? new TruAiAPI() : null;

    var API_BASE_STORAGE_KEY = 'gemini-api-base';
    function getDefaultApiBase() {
      return (window.location.origin + '/TruAi/api/v1').replace(/\/TruAi\/TruAi/, '/TruAi');
    }
    function getApiBase() {
      var saved = localStorage.getItem(API_BASE_STORAGE_KEY);
      return (saved && saved.trim()) ? saved.trim() : getDefaultApiBase();
    }

    function updateRoma(el, data) {
      if (!el) return;
      if (data && data.roma && data.portal_protected && data.monitor === 'active') {
        el.textContent = 'Roma \u2022 Portal protected \u2022 Monitor active';
        el.classList.add('confirmed');
      } else if (data && data.trust_state === 'BLOCKED') {
        el.textContent = 'Roma \u2022 Blocked (suspicion threshold)';
        el.classList.remove('confirmed');
      } else if (data && (data.trust_state === 'UNVERIFIED' || data.reason)) {
        el.textContent = 'Roma \u2022 Unverified (' + (data.reason || 'security check failed') + ')';
        el.classList.remove('confirmed');
      } else {
        el.textContent = 'Roma \u2022 Portal protected';
        el.classList.add('confirmed');
      }
    }

    function fetchRoma() {
      fetch(getApiBase() + '/security/roma', { credentials: 'include' })
        .then(r => r.json())
        .then(data => {
          updateRoma(document.getElementById('romaLogin'), data);
          updateRoma(document.getElementById('romaDashboard'), data);
        })
        .catch(() => {
          var el = document.getElementById('romaLogin');
          if (el) el.textContent = 'Roma \u2022 Unreachable (start TruAi server)';
          el = document.getElementById('romaDashboard');
          if (el) el.textContent = 'Roma \u2022 Unreachable';
        });
    }

    function reportOutcome(action, outcome) {
      if (!api || !window.TRUAI_CONFIG || !window.TRUAI_CONFIG.IS_AUTHENTICATED) return;
      const taskId = 'gemini-' + Date.now();
      api.reportSubordinateOutcome({
        system: 'gemini',
        task_id: taskId,
        outcome: outcome,
        user_action: 'accepted',
        latency_ms: 150,
        target: action
      }).catch(() => {});
    }

    function fetchGeminiStats() {
      fetch(getApiBase() + '/gemini/stats', { credentials: 'include' })
        .then(r => r.json())
        .then(data => {
          var el = document.getElementById('statNodes'); if (el) el.textContent = data.provisioned_nodes ?? '—';
          el = document.getElementById('statAlerts'); if (el) el.textContent = data.active_alerts ?? '—';
          el = document.getElementById('statCpu'); if (el) el.textContent = (data.avg_cpu_load != null ? data.avg_cpu_load + '%' : '—');
          el = document.getElementById('statUptime'); if (el) el.textContent = (data.uptime_percent != null ? data.uptime_percent + '%' : '—');
          var activityList = document.getElementById('activityList');
          if (activityList && data.activity && data.activity.length) {
            activityList.innerHTML = data.activity.map(function(a) {
              return '<li style="padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.1); font-size:13px; color:#A0A0A0">' + (a.summary || a.event || '') + '</li>';
            }).join('');
            var last = activityList.querySelector('li:last-child');
            if (last) last.style.borderBottom = 'none';
          }
          var alertsList = document.getElementById('alertsList');
          if (alertsList && data.alerts && data.alerts.length) {
            var iconMap = { high: '/TruAi/assets/GEMINI.CRITICAL-bd73c101-653a-4df8-ac3c-072f400c5206.png', medium: '/TruAi/assets/GEMINI.WARNING-5a42cb3a-e518-40d4-ba78-05ce296c73b3.png', low: '/TruAi/assets/GEMINI.OPTIMAL-5bb9b4e3-aa0c-47f3-8499-c1aaa72a395b.png' };
            alertsList.innerHTML = data.alerts.map(function(a) {
              var sev = a.severity || 'medium';
              var sevClass = 'severity-' + sev;
              var icon = iconMap[sev] || iconMap.medium;
              var remedy = a.remediation || 'Run Diagnostics';
              var ts = a.timestamp ? new Date(a.timestamp * 1000).toLocaleString() : '';
              return '<div class="alert-item ' + sevClass + '" data-alert-id="' + (a.id || '') + '" data-action="' + remedy + '" title="Click to run: ' + remedy + '"><img class="alert-icon" src="' + icon + '" alt="' + sev + '" aria-hidden="true"><div class="alert-body"><div class="alert-msg">' + (a.message || '') + '</div><div class="alert-meta">' + (a.node || '') + (ts ? ' · ' + ts : '') + '</div></div></div>';
            }).join('');
          }
          var usage = data.usage || {};
          el = document.getElementById('usageCalls'); if (el) el.textContent = usage.api_calls ?? '—';
          el = document.getElementById('usageTokens'); if (el) el.textContent = usage.tokens_estimate ?? usage.tokens_used ?? '—';
          el = document.getElementById('usageCost'); if (el) el.textContent = (usage.cost_estimate != null ? '$' + usage.cost_estimate : '—');
        })
        .catch(function() {
          var el = document.getElementById('statNodes'); if (el) el.textContent = '42';
          el = document.getElementById('statAlerts'); if (el) el.textContent = '3';
          el = document.getElementById('statCpu'); if (el) el.textContent = '27%';
          el = document.getElementById('statUptime'); if (el) el.textContent = '99.98%';
          var activityList = document.getElementById('activityList');
          if (activityList) activityList.innerHTML = '<li style="padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.1); font-size:13px; color:#A0A0A0">Auto-remediation applied to node gmn-07</li><li style="padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.1); font-size:13px; color:#A0A0A0">Failover tested successfully for region eu-west</li><li style="padding:10px 0; font-size:13px; color:#A0A0A0">Package updates completed on 12 hosts</li>';
          var alertsList = document.getElementById('alertsList');
          if (alertsList) {
            var iconMap = { high: '/TruAi/assets/GEMINI.CRITICAL-bd73c101-653a-4df8-ac3c-072f400c5206.png', medium: '/TruAi/assets/GEMINI.WARNING-5a42cb3a-e518-40d4-ba78-05ce296c73b3.png', low: '/TruAi/assets/GEMINI.OPTIMAL-5bb9b4e3-aa0c-47f3-8499-c1aaa72a395b.png' };
            alertsList.innerHTML = [
              { severity: 'high', message: 'Disk usage critical on gmn-07', node: 'gmn-07', remediation: 'Run Diagnostics' },
              { severity: 'medium', message: 'CPU trending above threshold', node: 'gmn-12', remediation: 'Scale Cluster' },
              { severity: 'low', message: 'All systems nominal', node: 'cluster', remediation: 'Run Diagnostics' }
            ].map(function(a) {
              var icon = iconMap[a.severity] || iconMap.medium;
              return '<div class="alert-item severity-' + a.severity + '" data-action="' + a.remediation + '" title="Click to run: ' + a.remediation + '"><img class="alert-icon" src="' + icon + '" alt="' + a.severity + '" aria-hidden="true"><div class="alert-body"><div class="alert-msg">' + a.message + '</div><div class="alert-meta">' + a.node + '</div></div></div>';
            }).join('');
          }
        });
    }

    function fetchGeminiInsights() {
      fetch(getApiBase() + '/gemini/insights', { credentials: 'include' })
        .then(r => r.json())
        .then(data => {
          var list = document.getElementById('insightsList');
          if (list && data.recommendations && data.recommendations.length) {
            var iconMap = { high: '/TruAi/assets/GEMINI.CRITICAL-bd73c101-653a-4df8-ac3c-072f400c5206.png', medium: '/TruAi/assets/GEMINI.WARNING-5a42cb3a-e518-40d4-ba78-05ce296c73b3.png', low: '/TruAi/assets/GEMINI.OPTIMAL-5bb9b4e3-aa0c-47f3-8499-c1aaa72a395b.png' };
            list.innerHTML = data.recommendations.map(function(r) {
              var pri = r.priority || 'medium';
              var icon = iconMap[pri] || iconMap.medium;
              return '<div class="insight-card priority-' + pri + '"><img class="insight-icon" src="' + icon + '" alt="' + pri + '" aria-hidden="true"><div class="insight-body"><h3>' + (r.title || '') + '</h3><p>' + (r.detail || '') + '</p><button class="action-btn" data-action="' + (r.action || '') + '">' + (r.action || 'Take action') + '</button></div></div>';
            }).join('');
          }
          var actionsList = document.getElementById('suggestedActionsList');
          if (actionsList && data.suggested_actions && data.suggested_actions.length) {
            actionsList.innerHTML = data.suggested_actions.map(function(a) {
              return '<button class="action-btn" data-action="' + a + '">' + a + '</button>';
            }).join('');
          }
        })
        .catch(function() {
          var list = document.getElementById('insightsList');
          var iconMap = { high: '/TruAi/assets/GEMINI.CRITICAL-bd73c101-653a-4df8-ac3c-072f400c5206.png', medium: '/TruAi/assets/GEMINI.WARNING-5a42cb3a-e518-40d4-ba78-05ce296c73b3.png', low: '/TruAi/assets/GEMINI.OPTIMAL-5bb9b4e3-aa0c-47f3-8499-c1aaa72a395b.png' };
          if (list) list.innerHTML = '<div class="insight-card priority-high"><img class="insight-icon" src="' + iconMap.high + '" alt="high" aria-hidden="true"><div class="insight-body"><h3>Consider scaling node gmn-07</h3><p>CPU trending up over last 24h. Projected 85% in 7 days.</p><button class="action-btn" data-action="Scale Cluster">Scale Cluster</button></div></div><div class="insight-card priority-medium"><img class="insight-icon" src="' + iconMap.medium + '" alt="medium" aria-hidden="true"><div class="insight-body"><h3>Apply security hardening</h3><p>2 security patches pending.</p><button class="action-btn" data-action="Apply Security Hardening">Apply Security Hardening</button></div></div>';
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
      fetchRoma();
      fetch(getApiBase() + '/auth/status', { credentials: 'include' })
        .then(r => r.json())
        .then(data => {
          if (data.authenticated) {
            if (window.TRUAI_CONFIG) {
              window.TRUAI_CONFIG.IS_AUTHENTICATED = true;
              window.TRUAI_CONFIG.USERNAME = data.username || '';
              window.TRUAI_CONFIG.CSRF_TOKEN = data.csrf_token || '';
            }
            loginView.style.display = 'none';
            disclaimerView.style.display = 'flex';
          }
        })
        .catch(() => {});
      fetchGeminiStats();
      fetchGeminiInsights();
    });

    document.getElementById('forgotPasswordLink')?.addEventListener('click', function(e) {
      e.preventDefault();
      alert('Credentials are stored in database/.initial_credentials after first setup or reset.\n\nTo reset: run from project root:\n  php reset-admin-password.php admin\n\nThen check database/.initial_credentials for the new password.');
    });

    loginForm.addEventListener('submit', function (e) {
      e.preventDefault();
      const u = document.getElementById('username').value.trim();
      const p = document.getElementById('password').value;
      if (!u || !p) return;
      const base = getApiBase();
      fetch(base + '/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ username: u, password: p })
      })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            if (window.TRUAI_CONFIG) {
              window.TRUAI_CONFIG.CSRF_TOKEN = data.csrf_token || '';
              window.TRUAI_CONFIG.IS_AUTHENTICATED = true;
              window.TRUAI_CONFIG.USERNAME = data.username || u;
            }
            loginView.style.display = 'none';
            disclaimerView.style.display = 'flex';
          } else {
            alert(data.error || 'Login failed');
          }
        })
        .catch(err => {
          alert('Login failed: ' + (err.message || 'Network error'));
        });
    });

    disclaimerAccept.addEventListener('click', function () {
      disclaimerView.style.display = 'none';
      dashboardView.style.display = 'block';
      dashboardView.classList.add('active');
      fetchRoma();
      fetchGeminiStats();
      fetchGeminiInsights();
    });

    disclaimerCancel.addEventListener('click', function () {
      disclaimerView.style.display = 'none';
      loginView.style.display = 'flex';
    });

    signOut.addEventListener('click', function (e) {
      e.preventDefault();
      fetch(getApiBase() + '/auth/logout', { method: 'POST', credentials: 'include' }).catch(() => {});
      if (window.TRUAI_CONFIG) window.TRUAI_CONFIG.IS_AUTHENTICATED = false;
      dashboardView.style.display = 'none';
      dashboardView.classList.remove('active');
      loginView.style.display = 'flex';
    });

    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', function (e) {
        if (this.id === 'signOut') return;
        e.preventDefault();
        const t = this.dataset.tab;
        document.querySelectorAll('.nav-tab').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(x => x.classList.remove('active'));
        this.classList.add('active');
        var panel = document.getElementById('tab-' + t);
        if (panel) panel.classList.add('active');
      });
    });

    document.addEventListener('click', function(e) {
      var btn = e.target.closest('.action-btn');
      if (!btn) return;
      if (btn.id === 'geminiChangePasswordBtn') {
        openGeminiChangePasswordModal();
        return;
      }
      var action = btn.dataset.action || btn.textContent;
      reportOutcome(action, 'success');
      alert('[Demo] ' + action + ' would execute. Outcome reported to TruAi Core.');
    });

    function openGeminiChangePasswordModal() {
      if (!api) { alert('API not available.'); return; }
      var current = prompt('Current password (********):');
      if (current === null) return;
      var newP = prompt('New password (******** min 8 chars):');
      if (newP === null) return;
      if (newP.length < 8) { alert('New password must be at least 8 characters.'); return; }
      var confirmP = prompt('Confirm new password (********):');
      if (confirmP === null) return;
      if (newP !== confirmP) { alert('Passwords do not match.'); return; }
      api.changePassword(current, newP).then(function() {
        alert('Password changed successfully.');
      }).catch(function(err) {
        alert('Failed: ' + (err.message || err.error || 'Unknown error'));
      });
    }

    document.getElementById('chatSuggestions')?.addEventListener('click', function(e) {
      var btn = e.target.closest('.suggest-btn');
      if (!btn || !chatInput) return;
      var prompt = btn.dataset.prompt || btn.textContent;
      chatInput.value = prompt;
      chatInput.focus();
    });

    (function setupChatApiSettings() {
      var toggle = document.getElementById('chatApiSettingsToggle');
      var panel = document.getElementById('chatApiSettingsPanel');
      var input = document.getElementById('chatApiBase');
      var keyInput = document.getElementById('chatOpenaiApiKey');
      var sonnetInput = document.getElementById('chatSonnetApiKey');
      var saveBtn = document.getElementById('chatApiSave');
      var testBtn = document.getElementById('chatApiTest');
      var resetBtn = document.getElementById('chatApiReset');
      if (!toggle || !panel || !input) return;
      toggle.addEventListener('click', function() {
        panel.classList.toggle('open');
        if (panel.classList.contains('open')) {
          input.value = getApiBase();
          if (api && window.TRUAI_CONFIG && window.TRUAI_CONFIG.IS_AUTHENTICATED) {
            api.getSettings().then(function(r) {
              if (r && r.settings && r.settings.ai) {
                if (keyInput) keyInput.value = r.settings.ai.openaiApiKey || '';
                if (sonnetInput) sonnetInput.value = r.settings.ai.anthropicApiKey || '';
              }
            }).catch(function() {});
          } else {
            if (keyInput) keyInput.value = '';
            if (sonnetInput) sonnetInput.value = '';
          }
        }
      });
      if (saveBtn) saveBtn.addEventListener('click', function() {
        var val = (input.value || '').trim();
        var keyVal = (keyInput && keyInput.value) ? keyInput.value.trim() : '';
        var sonnetVal = (sonnetInput && sonnetInput.value) ? sonnetInput.value.trim() : '';
        if (val) {
          localStorage.setItem(API_BASE_STORAGE_KEY, val);
          if (window.TRUAI_CONFIG) window.TRUAI_CONFIG.API_BASE = val;
          if (api) api.baseURL = val;
        } else {
          localStorage.removeItem(API_BASE_STORAGE_KEY);
          var def = getDefaultApiBase();
          if (window.TRUAI_CONFIG) window.TRUAI_CONFIG.API_BASE = def;
          if (api) api.baseURL = def;
          input.value = def;
        }
        if (api && window.TRUAI_CONFIG && window.TRUAI_CONFIG.IS_AUTHENTICATED) {
          api.saveSettings({ ai: { openaiApiKey: keyVal, anthropicApiKey: sonnetVal } }).then(function() {
            alert('API settings saved.' + (val ? ' Base URL: ' + val : ''));
          }).catch(function(err) {
            alert('Error saving OpenAI key: ' + (err && err.message ? err.message : 'Unknown error'));
          });
        } else {
          alert(val ? 'API base updated. New requests will use: ' + val : 'API base reset to default.');
        }
      });
      if (testBtn) testBtn.addEventListener('click', function() {
        if (!api || !window.TRUAI_CONFIG || !window.TRUAI_CONFIG.IS_AUTHENTICATED) {
          alert('Please log in to test API keys.');
          return;
        }
        var keyVal = (keyInput && keyInput.value) ? keyInput.value.trim() : '';
        var sonnetVal = (sonnetInput && sonnetInput.value) ? sonnetInput.value.trim() : '';
        if (!keyVal && !sonnetVal) {
          alert('Enter at least one API key to test.');
          return;
        }
        testBtn.disabled = true;
        testBtn.textContent = 'Testing…';
        api.testApiKeys(keyVal, sonnetVal).then(function(r) {
          var lines = [];
          if (r && r.results) {
            if (r.results.openai) {
              var o = r.results.openai;
              lines.push('OpenAI: ' + (o.status === 'success' ? '✓ ' + (o.message || 'OK') : o.status === 'not_configured' ? 'Not configured' : '✗ ' + (o.message || 'Error')));
            }
            if (r.results.anthropic) {
              var a = r.results.anthropic;
              lines.push('Sonnet: ' + (a.status === 'success' ? '✓ ' + (a.message || 'OK') : a.status === 'not_configured' ? 'Not configured' : '✗ ' + (a.message || 'Error')));
            }
          }
          alert(lines.length ? lines.join('\n') : 'Test complete.');
        }).catch(function(err) {
          alert('Test failed: ' + (err && err.message ? err.message : 'Unknown error'));
        }).finally(function() {
          testBtn.disabled = false;
          testBtn.textContent = 'Test all keys';
        });
      });
      if (resetBtn) resetBtn.addEventListener('click', function() {
        localStorage.removeItem(API_BASE_STORAGE_KEY);
        var def = getDefaultApiBase();
        if (window.TRUAI_CONFIG) window.TRUAI_CONFIG.API_BASE = def;
        if (api) api.baseURL = def;
        input.value = def;
        alert('API base reset to default.');
      });
    })();

    document.getElementById('alertsList')?.addEventListener('click', function(e) {
      var item = e.target.closest('.alert-item');
      if (!item) return;
      var action = item.dataset.action || 'Run Diagnostics';
      var msg = item.querySelector('.alert-msg')?.textContent || '';
      if (confirm('Alert: ' + msg + '\n\nRun "' + action + '" for remediation?')) {
        reportOutcome(action, 'success');
        alert('[Demo] ' + action + ' would execute. Outcome reported to TruAi Core.');
      }
    });

    const chatInput = document.getElementById('chatInput');
    const chatSend = document.getElementById('chatSend');
    const chatHistory = document.getElementById('chatHistory');
    const chatNewChat = document.getElementById('chatNewChat');
    const chatPastToggle = document.getElementById('chatPastToggle');
    const chatPastList = document.getElementById('chatPastList');
    var geminiCurrentConversationId = null;
    var GEMINI_CONV_STORAGE_KEY = 'gemini-last-conversation';
    if (chatSend && chatInput) {
      chatSend.addEventListener('click', sendChat);
      chatInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
      });
    }
    chatHistory?.addEventListener('click', function(e) {
      var wrap = e.target.closest('.chat-msg-wrap');
      if (!wrap) return;
      var msgSpan = wrap.querySelector('.chat-msg.ai span');
      var plainText = msgSpan ? msgSpan.textContent || '' : '';
      if (e.target.closest('.chat-copy')) {
        navigator.clipboard.writeText(plainText).then(function() { alert('Copied to clipboard.'); }).catch(function() { alert('Could not copy.'); });
      } else if (e.target.closest('.chat-send')) {
        if (chatInput) { chatInput.value = plainText; chatInput.focus(); }
      } else if (e.target.closest('.chat-share')) {
        if (navigator.share) {
          navigator.share({ title: 'Gemini.ai', text: plainText }).then(function() { alert('Shared.'); }).catch(function() {});
        } else {
          navigator.clipboard.writeText(plainText).then(function() { alert('Copied to clipboard (Share API not available).'); }).catch(function() { alert('Could not share.'); });
        }
      }
    });
    function mdToHtml(text) {
      var s = String(text || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
      s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\*(.+?)\*/g, '<em>$1</em>').replace(/__(.+?)__/g, '<strong>$1</strong>').replace(/_([^_]+)_/g, '<em>$1</em>');
      s = s.replace(/^### (.+)$/gm, '<strong>$1</strong>').replace(/^## (.+)$/gm, '<strong>$1</strong>').replace(/^# (.+)$/gm, '<strong>$1</strong>');
      s = s.replace(/^- (.+)$/gm, '<li>$1</li>').replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
      s = s.replace(/((?:<li>.*?<\/li>\s*)+)/g, '<ul>$1</ul>');
      s = s.replace(/\n\n/g, '<br><br>').replace(/\n/g, '<br>');
      return s;
    }
    function appendAiMessage(reply, msgId) {
        msgId = msgId || 'msg-' + Date.now();
        var wrap = document.createElement('div');
        wrap.className = 'chat-msg-wrap';
        var d = document.createElement('div');
        d.className = 'chat-msg ai';
        d.innerHTML = '<span class="md-content">' + mdToHtml(reply) + '</span>';
        var feedback = document.createElement('div');
        feedback.className = 'chat-feedback';
        var copyIcon = '<svg fill="currentColor" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>';
        var sendIcon = '<svg fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>';
        var shareIcon = '<svg fill="currentColor" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92 0-.22-.03-.44-.08-.65l7.12-4.16c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3z"/></svg>';
        feedback.innerHTML = '<button type="button" class="chat-action-btn chat-copy" title="Copy" aria-label="Copy">' + copyIcon + '</button><button type="button" class="chat-action-btn chat-send" title="Send to input" aria-label="Send to input">' + sendIcon + '</button><button type="button" class="chat-action-btn chat-share" title="Share" aria-label="Share">' + shareIcon + '</button><button type="button" class="feedback-up" data-msg-id="' + msgId + '" title="Helpful">👍</button><button type="button" class="feedback-down" data-msg-id="' + msgId + '" title="Not helpful">👎</button>';
        wrap.appendChild(d);
        wrap.appendChild(feedback);
        chatHistory.appendChild(wrap);
        chatHistory.scrollTop = chatHistory.scrollHeight;
        feedback.querySelectorAll('.feedback-up, .feedback-down').forEach(function(b) {
          b.addEventListener('click', function() {
            if (this.classList.contains('feedback-done')) return;
            var fid = this.dataset.msgId;
            var fb = this.classList.contains('feedback-up') ? 'thumbs_up' : 'thumbs_down';
            fetch(getApiBase() + '/gemini/chat/feedback', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ message_id: fid, feedback: fb })
            }).catch(function() {});
            feedback.querySelectorAll('.feedback-up, .feedback-down').forEach(function(x) { x.classList.add('feedback-done'); });
          });
        });
      }
    function sendChat() {
      const text = (chatInput && chatInput.value.trim()) || '';
      if (!text) return;
      var div = document.createElement('div');
      div.className = 'chat-msg user';
      div.innerHTML = '<span>' + text.replace(/</g, '&lt;') + '</span>';
      chatHistory.appendChild(div);
      chatInput.value = '';
      chatHistory.scrollTop = chatHistory.scrollHeight;
      if (api && window.TRUAI_CONFIG && window.TRUAI_CONFIG.IS_AUTHENTICATED) {
        api.sendMessage(text, geminiCurrentConversationId, 'auto', { scope: 'gemini', intent: 'server_management' })
          .then(res => {
            var convId = res && res.conversation_id;
            if (convId) {
              geminiCurrentConversationId = String(convId);
              try { sessionStorage.setItem(GEMINI_CONV_STORAGE_KEY, geminiCurrentConversationId); } catch(e) {}
            }
            var reply = (res && res.message && res.message.content) ? res.message.content : (res && res.reply) ? res.reply : '[Demo] Gemini.ai would respond here.';
            var msgId = (res && res.message && res.message.id) ? res.message.id : 'msg-' + Date.now();
            appendAiMessage(reply, msgId);
            loadConversationsList();
          })
          .catch(() => {
            appendAiMessage('[Demo] Response would appear here. Ensure TruAi server is running for live AI.');
          });
      } else {
        appendAiMessage('[Demo] AI Chat powered by TruAi Core. Sign in via TruAi for live responses.');
      }
    }
    function renderChatMessage(role, content) {
      if (role === 'user') {
        var div = document.createElement('div');
        div.className = 'chat-msg user';
        div.innerHTML = '<span>' + String(content || '').replace(/</g, '&lt;') + '</span>';
        chatHistory.appendChild(div);
      } else {
        var wrap = document.createElement('div');
        wrap.className = 'chat-msg-wrap';
        var d = document.createElement('div');
        d.className = 'chat-msg ai';
        d.innerHTML = '<span class="md-content">' + mdToHtml(content) + '</span>';
        var feedback = document.createElement('div');
        feedback.className = 'chat-feedback';
        var copyIcon = '<svg fill="currentColor" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>';
        var sendIcon = '<svg fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>';
        var shareIcon = '<svg fill="currentColor" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92 0-.22-.03-.44-.08-.65l7.12-4.16c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3z"/></svg>';
        feedback.innerHTML = '<button type="button" class="chat-action-btn chat-copy" title="Copy">' + copyIcon + '</button><button type="button" class="chat-action-btn chat-send" title="Send to input">' + sendIcon + '</button><button type="button" class="chat-action-btn chat-share" title="Share">' + shareIcon + '</button>';
        wrap.appendChild(d);
        wrap.appendChild(feedback);
        chatHistory.appendChild(wrap);
      }
    }
    function loadConversation(convId) {
      if (!api || !convId) return;
      api.getConversation(convId).then(function(conv) {
        if (!conv) return;
        var items = chatHistory.querySelectorAll('.chat-msg-wrap, .chat-msg.user');
        items.forEach(function(el) { el.remove(); });
        var msgs = conv.messages || [];
        if (msgs.length === 0) {
          chatHistory.innerHTML = '<div class="chat-msg-wrap"><div class="chat-msg ai"><span>Hello. How can Gemini.ai assist you today?</span></div><div class="chat-feedback"><button type="button" class="chat-action-btn chat-copy" title="Copy"><svg fill="currentColor" viewBox="0 0 24 24" width="14" height="14"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button><button type="button" class="chat-action-btn chat-send" title="Send to input"><svg fill="currentColor" viewBox="0 0 24 24" width="14" height="14"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button><button type="button" class="chat-action-btn chat-share" title="Share"><svg fill="currentColor" viewBox="0 0 24 24" width="14" height="14"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92 0-.22-.03-.44-.08-.65l7.12-4.16c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3z"/></svg></button></div></div>';
        } else {
          msgs.forEach(function(m) {
            renderChatMessage(m.role || 'assistant', m.content);
          });
        }
        geminiCurrentConversationId = String(convId);
        try { sessionStorage.setItem(GEMINI_CONV_STORAGE_KEY, geminiCurrentConversationId); } catch(e) {}
        loadConversationsList();
      }).catch(function() {});
    }
    function loadConversationsList() {
      if (!api || !window.TRUAI_CONFIG || !window.TRUAI_CONFIG.IS_AUTHENTICATED || !chatPastList) return;
      api.getConversations().then(function(r) {
        var convs = (r && r.conversations) ? r.conversations : [];
        if (convs.length === 0) {
          chatPastList.innerHTML = '<div class="chat-past-empty">No previous chats</div>';
          return;
        }
        chatPastList.innerHTML = convs.slice(0, 20).map(function(c) {
          var title = (c.title || 'Chat').replace(/</g, '&lt;');
          var sel = String(c.id) === String(geminiCurrentConversationId) ? ' selected' : '';
          return '<div class="chat-past-item' + sel + '" data-id="' + (c.id || '') + '"><span class="chat-past-title">' + title + '</span><button type="button" class="chat-past-delete" title="Remove chat" aria-label="Remove">×</button></div>';
        }).join('');
        chatPastList.querySelectorAll('.chat-past-item').forEach(function(row) {
          var id = row.dataset.id;
          row.querySelector('.chat-past-title')?.addEventListener('click', function() {
            if (id) loadConversation(id);
            chatPastList.classList.remove('open');
          });
          row.querySelector('.chat-past-delete')?.addEventListener('click', function(e) {
            e.stopPropagation();
            if (!id) return;
            if (!confirm('Remove this chat?')) return;
            api.deleteConversation(id).then(function() {
              if (String(id) === String(geminiCurrentConversationId)) {
                geminiCurrentConversationId = null;
                try { sessionStorage.removeItem(GEMINI_CONV_STORAGE_KEY); } catch(x) {}
                chatHistory.innerHTML = '<div class="chat-msg-wrap"><div class="chat-msg ai"><span>Hello. How can Gemini.ai assist you today?</span></div><div class="chat-feedback"><button type="button" class="chat-action-btn chat-copy" title="Copy"><svg fill="currentColor" viewBox="0 0 24 24" width="14" height="14"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button><button type="button" class="chat-action-btn chat-send" title="Send to input"><svg fill="currentColor" viewBox="0 0 24 24" width="14" height="14"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button><button type="button" class="chat-action-btn chat-share" title="Share"><svg fill="currentColor" viewBox="0 0 24 24" width="14" height="14"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92 0-.22-.03-.44-.08-.65l7.12-4.16c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3z"/></svg></button></div></div>';
              }
              row.remove();
              if (chatPastList.querySelectorAll('.chat-past-item').length === 0) {
                chatPastList.innerHTML = '<div class="chat-past-empty">No previous chats</div>';
              }
            }).catch(function() { alert('Could not remove chat.'); });
          });
        });
      }).catch(function() {
        chatPastList.innerHTML = '<div class="chat-past-empty">Could not load</div>';
      });
    }
    function initChatHistory() {
      if (!api || !window.TRUAI_CONFIG || !window.TRUAI_CONFIG.IS_AUTHENTICATED) return;
      var lastId = null;
      try { lastId = sessionStorage.getItem(GEMINI_CONV_STORAGE_KEY); } catch(e) {}
      if (lastId) {
        loadConversation(lastId);
      } else {
        api.getConversations().then(function(r) {
          var convs = (r && r.conversations) ? r.conversations : [];
          if (convs.length > 0 && convs[0].id) loadConversation(convs[0].id);
          else loadConversationsList();
        }).catch(function() { loadConversationsList(); });
      }
    }
    if (chatNewChat) chatNewChat.addEventListener('click', function() {
      geminiCurrentConversationId = null;
      try { sessionStorage.removeItem(GEMINI_CONV_STORAGE_KEY); } catch(e) {}
      var items = chatHistory.querySelectorAll('.chat-msg-wrap, .chat-msg.user');
      items.forEach(function(el) { el.remove(); });
      chatHistory.innerHTML = '<div class="chat-msg-wrap"><div class="chat-msg ai"><span>Hello. How can Gemini.ai assist you today?</span></div><div class="chat-feedback"><button type="button" class="chat-action-btn chat-copy" title="Copy"><svg fill="currentColor" viewBox="0 0 24 24" width="14" height="14"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button><button type="button" class="chat-action-btn chat-send" title="Send to input"><svg fill="currentColor" viewBox="0 0 24 24" width="14" height="14"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button><button type="button" class="chat-action-btn chat-share" title="Share"><svg fill="currentColor" viewBox="0 0 24 24" width="14" height="14"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92 0-.22-.03-.44-.08-.65l7.12-4.16c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3z"/></svg></button></div></div>';
      loadConversationsList();
    });
    if (chatPastToggle && chatPastList) chatPastToggle.addEventListener('click', function() {
      chatPastList.classList.toggle('open');
      if (chatPastList.classList.contains('open')) loadConversationsList();
    });
    document.addEventListener('click', function(e) {
      if (chatPastList && chatPastList.classList.contains('open') && !chatPastToggle.contains(e.target) && !chatPastList.contains(e.target)) {
        chatPastList.classList.remove('open');
      }
    });
    if (disclaimerView && dashboardView) {
      var obs = new MutationObserver(function() {
        if (dashboardView.style.display !== 'none') initChatHistory();
      });
      obs.observe(dashboardView, { attributes: true, attributeFilter: ['style'] });
      if (dashboardView.style.display !== 'none') initChatHistory();
    }
  </script>
</body>
</html>
